{% assign lang = page.lang | default: site.default_lang %}
{% assign t = site.data.translations[lang] %}
<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>{% if page.title %}{{ page.title | escape }} - {{ t.site_title | escape }}{% else %}{{ t.site_title | escape }}{% endif %}</title>
    <meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ t.description }}{% endif %}">
    
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <link rel="canonical" href="{{ page.url | replace:'index.html','' | absolute_url }}">
    
    {% seo %}
    {% feed_meta %}
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ '/assets/favicon.ico' | relative_url }}">
    <link rel="icon" type="image/svg+xml" href="{{ '/assets/favicon.svg' | relative_url }}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ '/manifest.json' | relative_url }}">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#D34516">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Incredible Rust">
    <link rel="apple-touch-icon" href="{{ '/assets/favicon.svg' | relative_url }}">
    
    <!-- Syntax highlighting -->
    <link rel="stylesheet" href="{{ '/assets/css/syntax.css' | relative_url }}">
</head>

<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <header class="site-header">
            <div class="wrapper">
                {% if lang == 'en' %}
                    <a class="site-title" href="{{ '/' | relative_url }}">
                        <span class="rust-logo">🦀</span>
                        {{ t.site_title }}
                    </a>
                {% elsif lang == 'pt' %}
                    <a class="site-title" href="{{ '/pt/' | relative_url }}">
                        <span class="rust-logo">🦀</span>
                        {{ t.site_title }}
                    </a>
                {% elsif lang == 'es' %}
                    <a class="site-title" href="{{ '/es/' | relative_url }}">
                        <span class="rust-logo">🦀</span>
                        {{ t.site_title }}
                    </a>
                {% endif %}
                
                <nav class="site-nav">
                    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
                    <label for="nav-trigger">
                        <span class="menu-icon">
                            <svg viewBox="0 0 18 15" width="18px" height="15px">
                                <path fill="#424242" d="m18,1.484c0,0.82-0.665,1.484-1.484,1.484h-15.031c-0.82,0-1.484-0.665-1.484-1.484s0.665-1.484,1.484-1.484h15.031c0.82,0,1.484,0.665,1.484,1.484zm0,5.515c0,0.82-0.665,1.484-1.484,1.484h-15.031c-0.82,0-1.484-0.665-1.484-1.484s0.665-1.484,1.484-1.484h15.031c0.82,0,1.484,0.665,1.484,1.484zm0,5.515c0,0.82-0.665,1.484-1.484,1.484h-15.031c-0.82,0-1.484-0.665-1.484-1.484s0.665-1.484,1.484-1.484h15.031c0.82,0,1.484,0.665,1.484,1.484z"/>
                            </svg>
                        </span>
                    </label>
                    
                    <div class="trigger">
                        {% if lang == 'en' %}
                            <a class="page-link" href="{{ '/lessons/' | relative_url }}">{{ t.nav.lessons }}</a>
                            <a class="page-link" href="{{ '/about/' | relative_url }}">{{ t.nav.about }}</a>
                        {% elsif lang == 'pt' %}
                            <a class="page-link" href="{{ '/pt/lessons/' | relative_url }}">{{ t.nav.lessons }}</a>
                            <a class="page-link" href="{{ '/pt/about/' | relative_url }}">{{ t.nav.about }}</a>
                        {% elsif lang == 'es' %}
                            <a class="page-link" href="{{ '/es/lessons/' | relative_url }}">{{ t.nav.lessons }}</a>
                            <a class="page-link" href="{{ '/es/about/' | relative_url }}">{{ t.nav.about }}</a>
                        {% endif %}
                        <a class="page-link" href="https://github.com/incrediblerust/incrediblerust.github.io" target="_blank">{{ t.nav.github }}</a>
                        
                        <!-- Modern Language Switcher -->
                        <div class="language-switcher">
                            <button class="lang-button" onclick="toggleLanguageMenu()" aria-label="Select Language" aria-expanded="false">
                                <span class="lang-flag">
                                    {% if lang == 'en' %}🇺🇸{% elsif lang == 'pt' %}🇧🇷{% elsif lang == 'es' %}🇪🇸{% endif %}
                                </span>
                                <span class="lang-text">{{ t.languages[lang] }}</span>
                                <svg class="lang-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none">
                                    <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <div class="lang-menu" id="langMenu" role="menu">
                                {% assign current_page = page.url %}
                                {% if current_page contains '/pt/' %}
                                    {% assign base_page = current_page | remove_first: '/pt' %}
                                {% elsif current_page contains '/es/' %}
                                    {% assign base_page = current_page | remove_first: '/es' %}
                                {% else %}
                                    {% assign base_page = current_page %}
                                {% endif %}
                                
                                {% if base_page == '/' %}
                                    <a href="{{ '/' | relative_url }}" class="lang-option {% if lang == 'en' %}active{% endif %}" role="menuitem">
                                        <span class="lang-flag">🇺🇸</span>
                                        <span class="lang-name">{{ site.data.translations.en.languages.en }}</span>
                                        <span class="lang-native">English</span>
                                    </a>
                                    <a href="{{ '/pt/' | relative_url }}" class="lang-option {% if lang == 'pt' %}active{% endif %}" role="menuitem">
                                        <span class="lang-flag">🇧🇷</span>
                                        <span class="lang-name">{{ site.data.translations.pt.languages.pt }}</span>
                                        <span class="lang-native">Português</span>
                                    </a>
                                    <a href="{{ '/es/' | relative_url }}" class="lang-option {% if lang == 'es' %}active{% endif %}" role="menuitem">
                                        <span class="lang-flag">🇪🇸</span>
                                        <span class="lang-name">{{ site.data.translations.es.languages.es }}</span>
                                        <span class="lang-native">Español</span>
                                    </a>
                                {% else %}
                                    <a href="{{ base_page | relative_url }}" class="lang-option {% if lang == 'en' %}active{% endif %}" role="menuitem">
                                        <span class="lang-flag">🇺🇸</span>
                                        <span class="lang-name">{{ site.data.translations.en.languages.en }}</span>
                                        <span class="lang-native">English</span>
                                    </a>
                                    <a href="{{ '/pt' | append: base_page | relative_url }}" class="lang-option {% if lang == 'pt' %}active{% endif %}" role="menuitem">
                                        <span class="lang-flag">🇧🇷</span>
                                        <span class="lang-name">{{ site.data.translations.pt.languages.pt }}</span>
                                        <span class="lang-native">Português</span>
                                    </a>
                                    <a href="{{ '/es' | append: base_page | relative_url }}" class="lang-option {% if lang == 'es' %}active{% endif %}" role="menuitem">
                                        <span class="lang-flag">🇪🇸</span>
                                        <span class="lang-name">{{ site.data.translations.es.languages.es }}</span>
                                        <span class="lang-native">Español</span>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <main class="page-content" aria-label="Content" id="main-content">
            <div class="wrapper">
                {{ content }}
            </div>
        </main>

        <footer class="site-footer">
            <div class="wrapper">
                <div class="footer-col-wrapper">
                    <div class="footer-col footer-col-1">
                        <ul class="contact-list">
                            <li>{{ site.title | escape }}</li>
                        </ul>
                    </div>
                    
                    <div class="footer-col footer-col-2">
                        <ul class="social-media-list">
                            <li><a href="https://github.com/incrediblerust" target="_blank">GitHub</a></li>
                            <li><a href="https://doc.rust-lang.org/" target="_blank">Rust Documentation</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-col footer-col-3">
                        <p>{{ site.description | escape }}</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <script>
        // Modern Language switcher functionality
        function toggleLanguageMenu() {
            const menu = document.getElementById('langMenu');
            const button = document.querySelector('.lang-button');
            const arrow = document.querySelector('.lang-arrow');
            const isOpen = menu.classList.contains('show');
            
            if (isOpen) {
                menu.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                menu.classList.add('show');
                button.setAttribute('aria-expanded', 'true');
                arrow.style.transform = 'rotate(180deg)';
            }
        }
        
        // Enhanced click outside handler
        document.addEventListener('click', function(event) {
            const switcher = document.querySelector('.language-switcher');
            const menu = document.getElementById('langMenu');
            const button = document.querySelector('.lang-button');
            const arrow = document.querySelector('.lang-arrow');
            
            if (!switcher.contains(event.target) && menu.classList.contains('show')) {
                menu.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
                arrow.style.transform = 'rotate(0deg)';
            }
        });
        
        // Keyboard navigation for language menu
        document.addEventListener('keydown', function(event) {
            const menu = document.getElementById('langMenu');
            const button = document.querySelector('.lang-button');
            const options = menu.querySelectorAll('.lang-option');
            
            if (event.key === 'Escape' && menu.classList.contains('show')) {
                menu.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
                button.focus();
            }
            
            if (event.key === 'ArrowDown' && menu.classList.contains('show')) {
                event.preventDefault();
                const focusedIndex = Array.from(options).findIndex(option => option === document.activeElement);
                const nextIndex = focusedIndex < options.length - 1 ? focusedIndex + 1 : 0;
                options[nextIndex].focus();
            }
            
            if (event.key === 'ArrowUp' && menu.classList.contains('show')) {
                event.preventDefault();
                const focusedIndex = Array.from(options).findIndex(option => option === document.activeElement);
                const prevIndex = focusedIndex > 0 ? focusedIndex - 1 : options.length - 1;
                options[prevIndex].focus();
            }
        });

        // Modern scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate');
                }
            });
        }, observerOptions);

        // Initialize animations when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Add animation classes to elements
            const features = document.querySelectorAll('.feature');
            const sections = document.querySelectorAll('h2, h3, p, .lesson-category');
            
            [...features, ...sections].forEach((el, index) => {
                el.classList.add('animate-on-scroll');
                observer.observe(el);
            });

            // Smooth scrolling for anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            // Add loading animation
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease';
                document.body.style.opacity = '1';
            }, 100);

            // Parallax effect for hero background
            const hero = document.querySelector('.hero');
            if (hero) {
                window.addEventListener('scroll', () => {
                    const scrolled = window.pageYOffset;
                    const parallax = scrolled * 0.3;
                    hero.style.transform = `translateY(${parallax}px)`;
                });
            }

            // Animated counters for stats
            function animateCounters() {
                const counters = document.querySelectorAll('.stat-number[data-count]');
                
                counters.forEach(counter => {
                    const target = parseInt(counter.getAttribute('data-count'));
                    const duration = 2000; // 2 seconds
                    const increment = target / (duration / 16); // 60fps
                    let current = 0;
                    
                    const updateCounter = () => {
                        if (current < target) {
                            current += increment;
                            counter.textContent = Math.floor(current) + (target >= 1000 ? '+' : '');
                            requestAnimationFrame(updateCounter);
                        } else {
                            counter.textContent = target + (target >= 1000 ? '+' : '');
                        }
                    };
                    
                    // Start animation when element is visible
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                updateCounter();
                                observer.unobserve(entry.target);
                            }
                        });
                    });
                    
                    observer.observe(counter);
                });
            }
            
            // Enhanced hover effects
            const interactiveElements = document.querySelectorAll('.cta-button, .feature, .page-link, .hero-feature');
            interactiveElements.forEach(element => {
                element.addEventListener('mouseenter', function() {
                    this.style.filter = 'brightness(1.05)';
                    this.style.transform = this.style.transform + ' scale(1.02)';
                });
                element.addEventListener('mouseleave', function() {
                    this.style.filter = 'brightness(1)';
                    this.style.transform = this.style.transform.replace(' scale(1.02)', '');
                });
            });
            
            // Initialize counter animation
            animateCounters();
            
            // AOS (Animate On Scroll) implementation
            function initAOS() {
                const aosElements = document.querySelectorAll('[data-aos]');
                
                const aosObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('aos-animate');
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                });
                
                aosElements.forEach(el => {
                    aosObserver.observe(el);
                });
            }
            
            // Initialize AOS
            initAOS();
            
            // Register Service Worker for PWA functionality
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('SW registered: ', registration);
                            
                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // Show update notification
                                        showUpdateNotification();
                                    }
                                });
                            });
                        })
                        .catch(registrationError => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
            
            // Show update notification
            function showUpdateNotification() {
                const notification = document.createElement('div');
                notification.className = 'update-notification';
                notification.innerHTML = `
                    <div class="notification-content">
                        <span>🎉 New content available!</span>
                        <button onclick="updateApp()" class="update-btn">Update</button>
                        <button onclick="dismissUpdate()" class="dismiss-btn">×</button>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
            }
            
            // Update app
            window.updateApp = function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration && registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            window.location.reload();
                        }
                    });
                }
            };
            
            // Dismiss update notification
            window.dismissUpdate = function() {
                const notification = document.querySelector('.update-notification');
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }
            };

            // Enhanced Progress bar for reading
            const progressBar = document.createElement('div');
            progressBar.className = 'reading-progress';
            progressBar.innerHTML = `
                <div class="reading-progress-fill"></div>
                <div class="reading-progress-glow"></div>
            `;
            document.body.appendChild(progressBar);

            let ticking = false;
            function updateProgress() {
                const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrolled = Math.min((winScroll / height) * 100, 100);
                
                const fill = document.querySelector('.reading-progress-fill');
                const glow = document.querySelector('.reading-progress-glow');
                
                if (fill) {
                    fill.style.width = scrolled + '%';
                    fill.style.background = `linear-gradient(90deg, 
                        var(--rust-orange) 0%, 
                        var(--rust-orange-light) ${scrolled/2}%, 
                        var(--rust-dark-blue) 100%)`;
                }
                
                if (glow) {
                    glow.style.width = scrolled + '%';
                    glow.style.opacity = scrolled > 5 ? '1' : '0';
                }
                
                ticking = false;
            }

            window.addEventListener('scroll', () => {
                if (!ticking) {
                    requestAnimationFrame(updateProgress);
                    ticking = true;
                }
            });
        });

        // Performance optimization - reduce animations on low-end devices
        if (navigator.hardwareConcurrency <= 2) {
            document.documentElement.style.setProperty('--transition-slow', '0.2s');
            document.documentElement.style.setProperty('--transition-normal', '0.15s');
        }
    </script>
</body>
</html>